<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otomono Admin Panel - Reports & Analytics</title>
    <meta name="description" content="Otomono Jerseys Admin Panel - Manage orders, customers, and business operations with our advanced reports.">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="public/favicon.png">
    <link rel="apple-touch-icon" href="public/favicon.png">

    <!-- ROG Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Direct Firebase configuration for admin panel
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNWEchdrKX9A2WdMa3VTnpbKgo0_eWqHE",
            authDomain: "otomono-c9938.firebaseapp.com",
            projectId: "otomono-c9938",
            storageBucket: "otomono-c9938.firebasestorage.app",
            messagingSenderId: "348906539551",
            appId: "1:348906539551:web:e249c40d0ae9e2964a632a",
            measurementId: "G-YVL497L1V3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseApp = app;
        window.firebaseDb = db;
        
        console.log('Firebase initialized for admin panel');
    </script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rog-red': '#ff0037',
                        'rog-orange': '#ff6b35',
                        'rog-dark': '#000000',
                        'rog-light': '#1a1a1a',
                        'rog-gray': '#333333',
                        'rog-blue': '#00d4ff',
                        'rog-purple': '#8b5cf6',
                    },
                    fontFamily: {
                        'rog-display': ['Orbitron', 'monospace'],
                        'rog-heading': ['Exo 2', 'sans-serif'],
                        'rog-body': ['Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'slide-in-left': 'slideInLeft 0.8s ease-out',
                        'slide-in-right': 'slideInRight 0.8s ease-out',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': {
                                opacity: '0'
                            },
                            '100%': {
                                opacity: '1'
                            },
                        },
                        slideUp: {
                            '0%': {
                                transform: 'translateY(30px)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'translateY(0)',
                                opacity: '1'
                            },
                        },
                        slideInLeft: {
                            '0%': {
                                transform: 'translateX(-30px)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'translateX(0)',
                                opacity: '1'
                            },
                        },
                        slideInRight: {
                            '0%': {
                                transform: 'translateX(30px)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'translateX(0)',
                                opacity: '1'
                            },
                        },
                        float: {
                            '0%, 100%': {
                                transform: 'translateY(0px)'
                            },
                            '50%': {
                                transform: 'translateY(-20px)'
                            },
                        },
                        glow: {
                            '0%': {
                                boxShadow: '0 0 20px rgba(220, 38, 38, 0.5)'
                            },
                            '100%': {
                                boxShadow: '0 0 30px rgba(220, 38, 38, 0.8)'
                            },
                        },
                    },
                }
            }
        }
    </script>

    <style>
        .rog-button {
            background: linear-gradient(135deg, #ff0037 0%, #ff6b35 50%, #00d4ff 100%);
            transition: all 0.3s ease;
            border: 1px solid #ff0037;
            box-shadow: 0 0 20px rgba(255, 0, 55, 0.3);
        }

        .rog-button:hover {
            background: linear-gradient(135deg, #ff6b35 0%, #ff0037 50%, #8b5cf6 100%);
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(255, 0, 55, 0.6);
            border-color: #00d4ff;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 30%, #333333 70%, #000000 100%);
            position: relative;
        }

        .hero-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(255, 0, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 0, 55, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .admin-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 25px 50px rgba(255, 0, 55, 0.3), 0 0 30px rgba(0, 212, 255, 0.2);
        }

        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* Active navigation state */
        nav a.active {
            background-color: rgba(255, 0, 55, 0.2);
            border-left: 3px solid #ff0037;
        }

        /* Mobile sidebar improvements */
        @media (max-width: 767px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar nav a {
                padding: 12px 16px;
                font-size: 16px;
            }
        }

        /* Desktop sidebar improvements */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
        }

        /* Header improvements for mobile */
        @media (max-width: 767px) {
            header {
                padding: 8px 12px;
            }

            header h1 {
                font-size: 16px;
            }

            header p {
                font-size: 10px;
            }

            /* Mobile header actions */
            .header-actions {
                gap: 6px;
            }

            .header-actions button {
                padding: 6px;
            }

            /* Mobile notification center */
            #notification-center {
                width: 280px;
                right: -10px;
            }

            /* Mobile user dropdown */
            #user-dropdown {
                width: 200px;
                right: -10px;
            }
        }

        /* Mobile main content */
        @media (max-width: 767px) {
            main {
                margin-left: 0;
                padding-top: 60px;
                min-height: calc(100vh - 60px);
            }

            main section {
                padding: 12px;
                margin-bottom: 20px;
            }

            /* Mobile cards */
            .admin-card {
                padding: 12px;
                margin-bottom: 16px;
            }

            /* Mobile tables */
            .overflow-x-auto {
                font-size: 14px;
            }

            /* Mobile modals */
            .modal-content {
                margin: 16px;
                max-width: calc(100vw - 32px);
            }

            /* Mobile order modal scrolling */
            #orderModal .flex {
                align-items: flex-start;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            #orderModal .bg-rog-light {
                margin: 0;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            /* Ensure content doesn't go below sidebar */
            .sidebar.open+main {
                margin-left: 0;
                padding-top: 60px;
            }
        }

        /* Tablet responsiveness */
        @media (min-width: 768px) and (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            main {
                margin-left: 280px;
            }
        }

        /* Settings page improvements */
        .settings-form input:focus,
        .settings-form textarea:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 0, 55, 0.3);
        }

        .settings-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 55, 0.4);
        }

        /* Password strength indicator */
        .password-strength {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .password-strength.weak {
            background: linear-gradient(90deg, #ff4444 0%, #ff4444 100%);
        }

        .password-strength.medium {
            background: linear-gradient(90deg, #ffaa00 0%, #ffaa00 100%);
        }

        .password-strength.strong {
            background: linear-gradient(90deg, #00ff88 0%, #00ff88 100%);
        }

        /* Branded Dialog Styles */
        .rog-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .rog-dialog-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            border: 2px solid #ff0037;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(255, 0, 55, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        .rog-dialog-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .rog-dialog-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 24px;
        }

        .rog-dialog-icon.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .rog-dialog-icon.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .rog-dialog-icon.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .rog-dialog-icon.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .rog-dialog-title {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'Orbitron', monospace;
        }

        .rog-dialog-message {
            color: #d1d5db;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .rog-dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .rog-dialog-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-family: 'Exo 2', sans-serif;
        }

        .rog-dialog-btn.primary {
            background: linear-gradient(135deg, #ff0037, #ff6b35);
            color: white;
        }

        .rog-dialog-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 55, 0.4);
        }

        .rog-dialog-btn.secondary {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }

        .rog-dialog-btn.secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .rog-dialog-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .rog-dialog-btn.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        /* Mobile responsive dialogs */
        @media (max-width: 640px) {
            .rog-dialog-content {
                margin: 16px;
                padding: 24px;
            }

            .rog-dialog-title {
                font-size: 20px;
            }

            .rog-dialog-actions {
                flex-direction: column;
            }

            .rog-dialog-btn {
                width: 100%;
            }
        }
    </style>

    <!-- Admin Authentication Protection -->
    <script>
        // Check admin authentication before page loads
        function checkAdminAuth() {
            console.log('Checking admin authentication...');

            // Check if admin user is logged in
            const adminUser = localStorage.getItem('adminUser');

            if (!adminUser) {
                console.log('No admin user found - redirecting to login');
                window.location.href = 'login.html';
                return false;
            }

            try {
                const adminData = JSON.parse(adminUser);
                console.log('Admin user found:', adminData);

                // Check if admin session is still valid (24 hours)
                const loginTime = new Date(adminData.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);

                if (hoursDiff > 24) {
                    console.log('Admin session expired - redirecting to login');
                    localStorage.removeItem('adminUser');
                    window.location.href = 'login.html';
                    return false;
                }

                console.log('Admin authentication successful');
                return true;
            } catch (error) {
                console.error('Error parsing admin user data:', error);
                localStorage.removeItem('adminUser');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Run authentication check immediately
        if (!checkAdminAuth()) {
            // Stop page loading if not authenticated
            document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #0a0a0a; color: #dc2626; font-family: Arial, sans-serif;"><div style="text-align: center;"><h2>Redirecting to login...</h2><p>Please wait...</p></div></div>';
        }
    </script>
</head>

<body class="bg-rog-dark text-white font-rog-body overflow-x-hidden">
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="toggleSidebar()"></div>

    <!-- Header -->
    <header class="sticky top-0 left-0 right-0 z-50 glass-effect">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <!-- Logo Section -->
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="md:hidden text-white hover:text-rog-red transition-colors duration-300">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-rog-red to-rog-orange rounded-lg flex items-center justify-center">
                            <i class="fas fa-cog text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-rog-display font-bold text-white">ADMIN PANEL</h1>
                            <p class="text-sm text-gray-400 font-rog-body">Management Dashboard</p>
                        </div>
                    </div>
                </div>

                <!-- Header Actions -->
                <div class="flex items-center space-x-4 header-actions">
                    <!-- Refresh Button -->
                    <button id="refresh-btn" class="p-2 text-white hover:text-rog-red transition-colors duration-300" title="Refresh Data">
                        <i class="fas fa-sync-alt text-xl"></i>
                    </button>

                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notification-btn" class="relative p-2 text-white hover:text-rog-red transition-colors duration-300" title="Notifications">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notification-count" class="absolute -top-2 -right-2 bg-rog-red text-white text-xs rounded-full h-5 w-5 flex items-center justify-center opacity-0 pointer-events-none">0</span>
                        </button>
                        <div id="notification-center" class="absolute right-0 mt-2 w-80 bg-rog-light rounded-lg shadow-lg border border-rog-red/30 hidden z-50">
                            <div class="p-4 border-b border-rog-gray">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-rog-heading font-semibold text-white">Notifications</h3>
                                        <p class="text-sm text-gray-400 font-rog-body">Client submissions and updates</p>
                                    </div>
                                    <button id="clear-all-notifications" class="text-xs text-rog-red hover:text-rog-orange transition-colors duration-300 font-rog-body">
                                        <i class="fas fa-trash mr-1"></i>Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto">
                                <div class="p-4 text-center text-gray-400">No notifications</div>
                            </div>
                        </div>
                    </div>

                    <!-- User Profile -->
                    <div class="relative">
                        <button id="user-profile-btn" class="w-10 h-10 bg-gradient-to-br from-rog-red to-rog-orange rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </button>
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-rog-light rounded-lg shadow-lg border border-rog-red/30 hidden">
                            <div class="p-4 border-b border-rog-gray">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-rog-red to-rog-orange rounded-full flex items-center justify-center" id="admin-avatar">
                                        <i class="fas fa-user text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-400 font-rog-body">Signed in as</p>
                                        <p class="font-rog-heading font-semibold text-white" id="admin-name">Admin User</p>
                                        <p class="text-xs text-gray-400 font-rog-body" id="admin-email">admin@otomono.mv</p>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 font-rog-body">
                                    <p>Session: <span id="session-duration">0h 0m</span></p>
                                </div>
                            </div>
                            <div class="py-2">
                                <a href="#" class="block px-3 py-2 text-sm hover:bg-rog-gray rounded font-rog-body">Profile</a>
                                <a href="admin-settings.html" class="block px-3 py-2 text-sm hover:bg-rog-gray rounded font-rog-body">Settings</a>
                                <a href="#" onclick="showHelpDialog()" class="block px-3 py-2 text-sm hover:bg-rog-gray rounded font-rog-body">Help</a>
                                <hr class="my-2 border-rog-gray">
                                <a href="#" class="block px-3 py-2 text-sm hover:bg-rog-gray rounded text-rog-red font-rog-body" onclick="logout()">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-80 bg-rog-light shadow-2xl z-50 md:translate-x-0">
        <div class="flex items-center justify-between p-6 border-b border-rog-gray">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-br from-rog-red to-rog-orange rounded-lg flex items-center justify-center">
                    <i class="fas fa-cog text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="text-lg font-rog-display font-bold text-white">ADMIN</h1>
                    <p class="text-xs text-gray-400 font-rog-body">Dashboard</p>
                </div>
            </div>
            <button id="sidebar-close" class="md:hidden text-white hover:text-rog-red transition-colors duration-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <nav class="p-6 space-y-2" id="sidebar-nav">
            <a href="admin-dashboard.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="dashboard">
                <i class="fas fa-tachometer-alt text-rog-red"></i>
                <span>Dashboard</span>
            </a>
            <a href="admin-orders.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="orders">
                <i class="fas fa-shopping-cart text-rog-red"></i>
                <span>Orders</span>
            </a>
            <a href="admin-customers.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="customers">
                <i class="fas fa-users text-rog-red"></i>
                <span>Customers</span>
            </a>
            <a href="admin-materials.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="materials">
                <i class="fas fa-layer-group text-rog-red"></i>
                <span>Materials</span>
            </a>
            <a href="https://otomonodesignner.vercel.app/" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="design-studio">
                <i class="fas fa-paint-brush text-rog-red"></i>
                <span>Design Studio</span>
            </a>
            <a href="admin-analytics.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="analytics">
                <i class="fas fa-chart-line text-rog-red"></i>
                <span>Analytics</span>
            </a>
            <a href="admin-reports.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="reports">
                <i class="fas fa-file-alt text-rog-red"></i>
                <span>Reports</span>
            </a>
            <a href="admin-settings.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-white hover:bg-rog-gray rounded-lg transition-colors duration-300 font-rog-body" data-page="settings">
                <i class="fas fa-cog text-rog-red"></i>
                <span>Settings</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="md:ml-80 pt-16">
        <section id="reports" class="p-6">
            <div class="mb-8">
                <h2 class="text-3xl font-rog-display font-bold text-white mb-4">Reports & Analytics</h2>
                <p class="text-gray-400 font-rog-body">Generate and download business reports</p>
            </div>

            <!-- Report Filters -->
            <div class="bg-rog-light/20 backdrop-blur-sm rounded-2xl border border-rog-red/30 p-6 mb-8">
                <h3 class="text-xl font-rog-heading font-semibold text-white mb-4">Report Filters</h3>
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Report Type</label>
                        <select id="report-type" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                            <option value="sales">Sales Report</option>
                            <option value="customers">Customer Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="financial">Financial Report</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Date From</label>
                        <input type="date" id="report-date-from" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                    </div>
                    <div>
                        <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Date To</label>
                        <input type="date" id="report-date-to" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                    </div>
                    <div class="flex items-end">
                        <button id="generate-report" class="w-full rog-button py-3 rounded-lg font-rog-heading font-semibold text-white">
                            <i class="fas fa-file-alt mr-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Types -->
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="admin-card bg-rog-light/20 backdrop-blur-sm p-6 rounded-2xl border border-rog-red/30 hover:border-rog-red transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-rog-red to-rog-orange rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-shopping-cart text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-rog-heading font-semibold text-white">Sales Report</h3>
                            <p class="text-sm text-gray-400 font-rog-body">Order and revenue data</p>
                        </div>
                    </div>
                    <button class="w-full rog-button py-2 rounded-lg font-rog-heading font-semibold text-white" onclick="generateReport('sales')">
                        <i class="fas fa-download mr-2"></i>Generate Report
                    </button>
                </div>

                <div class="admin-card bg-rog-light/20 backdrop-blur-sm p-6 rounded-2xl border border-rog-red/30 hover:border-rog-red transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-rog-blue to-rog-purple rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-rog-heading font-semibold text-white">Customer Report</h3>
                            <p class="text-sm text-gray-400 font-rog-body">Customer analytics</p>
                        </div>
                    </div>
                    <button class="w-full rog-button py-2 rounded-lg font-rog-heading font-semibold text-white" onclick="generateReport('customers')">
                        <i class="fas fa-download mr-2"></i>Generate Report
                    </button>
                </div>

                <div class="admin-card bg-rog-light/20 backdrop-blur-sm p-6 rounded-2xl border border-rog-red/30 hover:border-rog-red transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-tshirt text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-rog-heading font-semibold text-white">Inventory Report</h3>
                            <p class="text-sm text-gray-400 font-rog-body">Stock and product data</p>
                        </div>
                    </div>
                    <button class="w-full rog-button py-2 rounded-lg font-rog-heading font-semibold text-white" onclick="generateReport('inventory')">
                        <i class="fas fa-download mr-2"></i>Generate Report
                    </button>
                </div>

                <div class="admin-card bg-rog-light/20 backdrop-blur-sm p-6 rounded-2xl border border-rog-red/30 hover:border-rog-red transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-rog-heading font-semibold text-white">Financial Report</h3>
                            <p class="text-sm text-gray-400 font-rog-body">Revenue and profit data</p>
                        </div>
                    </div>
                    <button class="w-full rog-button py-2 rounded-lg font-rog-heading font-semibold text-white" onclick="generateReport('financial')">
                        <i class="fas fa-download mr-2"></i>Generate Report
                    </button>
                </div>
            </div>

            <!-- Recent Reports -->
            <div class="bg-rog-light/20 backdrop-blur-sm rounded-2xl border border-rog-red/30 p-6">
                <h3 class="text-xl font-rog-heading font-semibold text-white mb-6">Recent Reports</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-rog-gray">
                                <th class="text-left py-3 px-4 font-rog-heading font-semibold text-white">Report Name</th>
                                <th class="text-left py-3 px-4 font-rog-heading font-semibold text-white">Type</th>
                                <th class="text-left py-3 px-4 font-rog-heading font-semibold text-white">Generated</th>
                                <th class="text-left py-3 px-4 font-rog-heading font-semibold text-white">Size</th>
                                <th class="text-left py-3 px-4 font-rog-heading font-semibold text-white">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <!-- Reports will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Shared Common JavaScript -->
    <script src="js/admin-common.js"></script>

    <!-- Page-Specific JavaScript -->
    <script type="module">
        import { initializeFirebase } from './js/admin-common.js';
        
        // Import Firebase functions
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Make Firestore functions available globally
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.onSnapshot = onSnapshot;

        // Components are already inline, just need to initialize
        // Use functions from admin-common.js

        // Navigation functions
        function navigateToSettings() {
            window.location.href = 'admin-settings.html';
        }

        function navigateToOrders() {
            window.location.href = 'admin-orders.html';
        }

        function navigateToAnalytics() {
            window.location.href = 'admin-analytics.html';
        }

        function navigateToReports() {
            window.location.href = 'admin-reports.html';
        }

        // Logout function
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A';
                return date.toLocaleDateString();
            } catch (error) {
                return 'N/A';
            }
        }

        function showRogDialog(options) {
            const { type = 'info', title = 'Notification', message = '', confirmText = 'OK', cancelText = 'Cancel', showCancel = false, onConfirm = null, onCancel = null } = options;
            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };
            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = { onConfirm, onCancel };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => dialog.remove(), 300);
            }
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) callbacks.onConfirm();
                else if (!confirmed && callbacks.onCancel) callbacks.onCancel();
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({ type: 'success', title, message, confirmText: 'OK' });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({ type: 'error', title, message, confirmText: 'OK' });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({ type: 'warning', title, message, confirmText: 'Yes', cancelText: 'No', showCancel: true, onConfirm, onCancel });
        }

        // Page-specific JavaScript
async function loadReportsData() {
            try {
                console.log('Loading reports data...');
                await loadRecentReports();
                setupReportsFunctionality();
            } catch (error) {
                console.error('Error loading reports data:', error);
            }
        }

        // Load recent reports
        async function loadRecentReports() {
            try {
                const reports = await generateDynamicReports();
                window.dynamicReports = reports; // Store globally for access
                renderReportsTable(reports);
            } catch (error) {
                console.error('Error loading recent reports:', error);
            }
        }

        // Generate dynamic reports based on actual data
        async function generateDynamicReports() {
            try {
                const reports = [];
                const currentDate = new Date();

                // Generate Sales Report
                const totalSales = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const completedOrders = ordersData.filter(order => order.status === 'Completed').length;

                reports.push({
                    id: 1,
                    name: `Sales Report - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Sales',
                    generated: currentDate.toISOString().split('T')[0],
                    size: `${(Math.random() * 2 + 1).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalSales,
                        completedOrders,
                        averageOrderValue: completedOrders > 0 ? (totalSales / completedOrders).toFixed(2) : 0
                    }
                });

                // Generate Customer Report
                const totalCustomers = customersData.length;
                const newCustomersThisMonth = customersData.filter(customer => {
                    const customerDate = new Date(customer.date || customer.createdAt);
                    const currentMonth = new Date().getMonth();
                    return customerDate.getMonth() === currentMonth;
                }).length;

                reports.push({
                    id: 2,
                    name: `Customer Analytics - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Customer',
                    generated: new Date(currentDate.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.5 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalCustomers,
                        newCustomersThisMonth,
                        customerGrowthRate: totalCustomers > 0 ? ((newCustomersThisMonth / totalCustomers) * 100).toFixed(1) : 0
                    }
                });

                // Generate Inventory Report
                const totalProducts = productsData.length;
                const totalMaterials = materialsData.length;
                const lowStockProducts = productsData.filter(product => (product.stock || 0) < 10).length;

                reports.push({
                    id: 3,
                    name: `Inventory Status Report - ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
                    type: 'Inventory',
                    generated: new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalProducts,
                        totalMaterials,
                        lowStockProducts,
                        inventoryValue: productsData.reduce((sum, product) => sum + ((product.price || 0) * (product.stock || 0)), 0)
                    }
                });

                // Generate Financial Report
                const totalRevenue = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const pendingRevenue = ordersData.filter(order => order.status === 'Pending').reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);

                reports.push({
                    id: 4,
                    name: `Financial Report - Q${Math.ceil((currentDate.getMonth() + 1) / 3)} ${currentDate.getFullYear()}`,
                    type: 'Financial',
                    generated: new Date(currentDate.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.8 + 0.7).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalRevenue,
                        pendingRevenue,
                        profitMargin: totalRevenue > 0 ? ((totalRevenue - pendingRevenue) / totalRevenue * 100).toFixed(1) : 0
                    }
                });

                return reports;
            } catch (error) {
                console.error('Error generating dynamic reports:', error);
                return [];
            }
        }

        // Render reports table
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reports-table-body');
            if (!tbody) return;

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400 font-rog-body">No reports found</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.name}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.type}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.generated}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.size}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewReport('${report.id}')" title="View Report">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="exportReport('${report.id}')" title="Export Report">
                                <i class="fas fa-file-export"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="downloadReport('${report.id}')" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteReport('${report.id}')" title="Delete Report">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Setup reports functionality
        function setupReportsFunctionality() {
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await generateCustomReport();
                });
            }

            // Refresh reports button
            const refreshReportsBtn = document.getElementById('refresh-reports');
            if (refreshReportsBtn) {
                refreshReportsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await loadRecentReports();
                });
            }
        }

        // Generate custom report
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        async function loadRecentReports() {
            try {
                const reports = await generateDynamicReports();
                window.dynamicReports = reports; // Store globally for access
                renderReportsTable(reports);
            } catch (error) {
                console.error('Error loading recent reports:', error);
            }
        }

        // Generate dynamic reports based on actual data
        async function generateDynamicReports() {
            try {
                const reports = [];
                const currentDate = new Date();

                // Generate Sales Report
                const totalSales = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const completedOrders = ordersData.filter(order => order.status === 'Completed').length;

                reports.push({
                    id: 1,
                    name: `Sales Report - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Sales',
                    generated: currentDate.toISOString().split('T')[0],
                    size: `${(Math.random() * 2 + 1).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalSales,
                        completedOrders,
                        averageOrderValue: completedOrders > 0 ? (totalSales / completedOrders).toFixed(2) : 0
                    }
                });

                // Generate Customer Report
                const totalCustomers = customersData.length;
                const newCustomersThisMonth = customersData.filter(customer => {
                    const customerDate = new Date(customer.date || customer.createdAt);
                    const currentMonth = new Date().getMonth();
                    return customerDate.getMonth() === currentMonth;
                }).length;

                reports.push({
                    id: 2,
                    name: `Customer Analytics - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Customer',
                    generated: new Date(currentDate.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.5 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalCustomers,
                        newCustomersThisMonth,
                        customerGrowthRate: totalCustomers > 0 ? ((newCustomersThisMonth / totalCustomers) * 100).toFixed(1) : 0
                    }
                });

                // Generate Inventory Report
                const totalProducts = productsData.length;
                const totalMaterials = materialsData.length;
                const lowStockProducts = productsData.filter(product => (product.stock || 0) < 10).length;

                reports.push({
                    id: 3,
                    name: `Inventory Status Report - ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
                    type: 'Inventory',
                    generated: new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalProducts,
                        totalMaterials,
                        lowStockProducts,
                        inventoryValue: productsData.reduce((sum, product) => sum + ((product.price || 0) * (product.stock || 0)), 0)
                    }
                });

                // Generate Financial Report
                const totalRevenue = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const pendingRevenue = ordersData.filter(order => order.status === 'Pending').reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);

                reports.push({
                    id: 4,
                    name: `Financial Report - Q${Math.ceil((currentDate.getMonth() + 1) / 3)} ${currentDate.getFullYear()}`,
                    type: 'Financial',
                    generated: new Date(currentDate.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.8 + 0.7).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalRevenue,
                        pendingRevenue,
                        profitMargin: totalRevenue > 0 ? ((totalRevenue - pendingRevenue) / totalRevenue * 100).toFixed(1) : 0
                    }
                });

                return reports;
            } catch (error) {
                console.error('Error generating dynamic reports:', error);
                return [];
            }
        }

        // Render reports table
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reports-table-body');
            if (!tbody) return;

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400 font-rog-body">No reports found</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.name}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.type}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.generated}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.size}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewReport('${report.id}')" title="View Report">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="exportReport('${report.id}')" title="Export Report">
                                <i class="fas fa-file-export"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="downloadReport('${report.id}')" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteReport('${report.id}')" title="Delete Report">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Setup reports functionality
        function setupReportsFunctionality() {
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await generateCustomReport();
                });
            }

            // Refresh reports button
            const refreshReportsBtn = document.getElementById('refresh-reports');
            if (refreshReportsBtn) {
                refreshReportsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await loadRecentReports();
                });
            }
        }

        // Generate custom report
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        async function generateDynamicReports() {
            try {
                const reports = [];
                const currentDate = new Date();

                // Generate Sales Report
                const totalSales = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const completedOrders = ordersData.filter(order => order.status === 'Completed').length;

                reports.push({
                    id: 1,
                    name: `Sales Report - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Sales',
                    generated: currentDate.toISOString().split('T')[0],
                    size: `${(Math.random() * 2 + 1).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalSales,
                        completedOrders,
                        averageOrderValue: completedOrders > 0 ? (totalSales / completedOrders).toFixed(2) : 0
                    }
                });

                // Generate Customer Report
                const totalCustomers = customersData.length;
                const newCustomersThisMonth = customersData.filter(customer => {
                    const customerDate = new Date(customer.date || customer.createdAt);
                    const currentMonth = new Date().getMonth();
                    return customerDate.getMonth() === currentMonth;
                }).length;

                reports.push({
                    id: 2,
                    name: `Customer Analytics - ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`,
                    type: 'Customer',
                    generated: new Date(currentDate.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.5 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalCustomers,
                        newCustomersThisMonth,
                        customerGrowthRate: totalCustomers > 0 ? ((newCustomersThisMonth / totalCustomers) * 100).toFixed(1) : 0
                    }
                });

                // Generate Inventory Report
                const totalProducts = productsData.length;
                const totalMaterials = materialsData.length;
                const lowStockProducts = productsData.filter(product => (product.stock || 0) < 10).length;

                reports.push({
                    id: 3,
                    name: `Inventory Status Report - ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
                    type: 'Inventory',
                    generated: new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1 + 0.5).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalProducts,
                        totalMaterials,
                        lowStockProducts,
                        inventoryValue: productsData.reduce((sum, product) => sum + ((product.price || 0) * (product.stock || 0)), 0)
                    }
                });

                // Generate Financial Report
                const totalRevenue = ordersData.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                const pendingRevenue = ordersData.filter(order => order.status === 'Pending').reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);

                reports.push({
                    id: 4,
                    name: `Financial Report - Q${Math.ceil((currentDate.getMonth() + 1) / 3)} ${currentDate.getFullYear()}`,
                    type: 'Financial',
                    generated: new Date(currentDate.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    size: `${(Math.random() * 1.8 + 0.7).toFixed(1)} MB`,
                    status: 'Ready',
                    data: {
                        totalRevenue,
                        pendingRevenue,
                        profitMargin: totalRevenue > 0 ? ((totalRevenue - pendingRevenue) / totalRevenue * 100).toFixed(1) : 0
                    }
                });

                return reports;
            } catch (error) {
                console.error('Error generating dynamic reports:', error);
                return [];
            }
        }

        // Render reports table
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reports-table-body');
            if (!tbody) return;

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400 font-rog-body">No reports found</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.name}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.type}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.generated}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.size}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewReport('${report.id}')" title="View Report">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="exportReport('${report.id}')" title="Export Report">
                                <i class="fas fa-file-export"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="downloadReport('${report.id}')" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteReport('${report.id}')" title="Delete Report">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Setup reports functionality
        function setupReportsFunctionality() {
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await generateCustomReport();
                });
            }

            // Refresh reports button
            const refreshReportsBtn = document.getElementById('refresh-reports');
            if (refreshReportsBtn) {
                refreshReportsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await loadRecentReports();
                });
            }
        }

        // Generate custom report
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function renderReportsTable(reports) {
            const tbody = document.getElementById('reports-table-body');
            if (!tbody) return;

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400 font-rog-body">No reports found</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(report => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.name}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.type}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.generated}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${report.size}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewReport('${report.id}')" title="View Report">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="exportReport('${report.id}')" title="Export Report">
                                <i class="fas fa-file-export"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="downloadReport('${report.id}')" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteReport('${report.id}')" title="Delete Report">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Setup reports functionality
        function setupReportsFunctionality() {
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await generateCustomReport();
                });
            }

            // Refresh reports button
            const refreshReportsBtn = document.getElementById('refresh-reports');
            if (refreshReportsBtn) {
                refreshReportsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await loadRecentReports();
                });
            }
        }

        // Generate custom report
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function setupReportsFunctionality() {
            // Generate report button
            const generateReportBtn = document.getElementById('generate-report');
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await generateCustomReport();
                });
            }

            // Refresh reports button
            const refreshReportsBtn = document.getElementById('refresh-reports');
            if (refreshReportsBtn) {
                refreshReportsBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await loadRecentReports();
                });
            }
        }

        // Generate custom report
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        async function generateCustomReport() {
            try {
                const reportType = document.getElementById('report-type').value;
                const dateFrom = document.getElementById('report-date-from').value;
                const dateTo = document.getElementById('report-date-to').value;

                if (!dateFrom || !dateTo) {
                    showRogError('Please select date range', 'Missing Information');
                    return;
                }

                console.log(`Generating ${reportType} report from ${dateFrom} to ${dateTo}`);

                // Simulate report generation
                const reportName = `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${dateFrom} to ${dateTo}`;

                // Add to recent reports
                const newReport = {
                    id: Date.now(),
                    name: reportName,
                    type: reportType.charAt(0).toUpperCase() + reportType.slice(1),
                    generated: new Date().toISOString().split('T')[0],
                    size: '1.5 MB',
                    status: 'Ready'
                };

                // Add the new report to the existing reports array
                if (window.dynamicReports) {
                    window.dynamicReports.unshift(newReport); // Add to beginning of array
                } else {
                    window.dynamicReports = [newReport];
                }

                // Update the table
                renderReportsTable(window.dynamicReports);

                showRogSuccess('Report generated successfully!', 'Report Generated');
            } catch (error) {
                console.error('Error generating report:', error);
                showRogError('Error generating report. Please try again.', 'Generation Failed');
            }
        }

        // Generate report by type
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function generateReport(type) {
            console.log(`Generating ${type} report...`);
            // Set the report type in the filter
            document.getElementById('report-type').value = type;

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('report-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('report-date-to').value = today.toISOString().split('T')[0];

            // Generate the report
            generateCustomReport();
        }

        // View report details
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function viewReport(reportId) {
            console.log(`Viewing report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show report details modal
            showReportDetailsModal(report);
        }

        // Export report
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function exportReport(reportId) {
            console.log(`Exporting report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Show export options modal
            showExportOptionsModal(report);
        }

        // Download report
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function downloadReport(reportId) {
            console.log(`Downloading report ${reportId}...`);
            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                return;
            }

            // Create a simple text report content
            const reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: 'text/plain'
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess('Report downloaded successfully!', 'Download Complete');
        }

        // Show report details modal
        function showReportDetailsModal(report) {
            const modalHtml = `
                <div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">${report.name}</h3>
                                <button onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Information</h4>
                                        <div class="space-y-2">
                                            <p class="text-gray-300"><span class="text-rog-red">Type:</span> ${report.type}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Generated:</span> ${report.generated}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Size:</span> ${report.size}</p>
                                            <p class="text-gray-300"><span class="text-rog-red">Status:</span> <span class="text-green-400">${report.status}</span></p>
                                        </div>
                                    </div>
                                    <div class="bg-rog-light/20 rounded-lg p-4">
                                        <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Key Metrics</h4>
                                        <div class="space-y-2">
                                            ${Object.entries(report.data || {}).map(([key, value]) => 
                                                ` < p class = "text-gray-300" > < span class = "text-rog-red" > $ {
                key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())
            }: < /span> ${value}</p > `
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">Report Summary</h4>
                                    <p class="text-gray-300">
                                        This ${report.type.toLowerCase()} report contains comprehensive data analysis 
                                        generated on ${report.generated}. The report includes key performance indicators 
                                        and business metrics relevant to your ${report.type.toLowerCase()} operations.
                                    </p>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeReportDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Show export options modal
        function showExportOptionsModal(report) {
            const modalHtml = `
                <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-md">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Export Report</h3>
                                <button onclick="closeExportOptionsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Export Format</label>
                                    <select id="export-format" class="w-full px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-rog-red">
                                        <option value="pdf">PDF Document</option>
                                        <option value="excel">Excel Spreadsheet</option>
                                        <option value="csv">CSV File</option>
                                        <option value="json">JSON Data</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Include Logo</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="yes" checked class="mr-2 text-rog-red">
                                            <span class="text-white">Yes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="include-logo" value="no" class="mr-2 text-rog-red">
                                            <span class="text-white">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6 space-x-3">
                                <button onclick="closeExportOptionsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Cancel
                                </button>
                                <button onclick="executeExport('${report.id}')" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close report details modal
        function closeReportDetailsModal() {
            const modal = document.getElementById('reportDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close export options modal
        function closeExportOptionsModal() {
            const modal = document.getElementById('exportOptionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Execute export
        function executeExport(reportId) {
            const format = document.getElementById('export-format').value;
            const includeLogo = document.querySelector('input[name="include-logo"]:checked').value === 'yes';

            console.log(`Exporting report ${reportId} as ${format} with logo: ${includeLogo}`);

            // Find the report
            const report = window.dynamicReports ? .find(r => r.id == reportId);
            if (!report) {
                showRogError('Report not found', 'Report Not Found');
                closeExportOptionsModal();
                return;
            }

            // Create report content based on format
            let reportContent = '';
            let mimeType = '';
            let fileExtension = '';

            switch (format) {
                case 'pdf':
                    // For PDF, we'll create a simple text file that can be converted to PDF
                    reportContent = `Report: ${report.name}
Type: ${report.type}
Generated: ${report.generated}
Size: ${report.size}
Status: ${report.status}

Report Data:
${JSON.stringify(report.data || {}, null, 2)}`;
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
                    break;
                case 'excel':
                    // Create CSV format for Excel compatibility
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'csv':
                    reportContent = `Report Name,Type,Generated,Size,Status
"${report.name}","${report.type}","${report.generated}","${report.size}","${report.status}"`;
                    mimeType = 'text/csv';
                    fileExtension = 'csv';
                    break;
                case 'json':
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'application/json';
                    fileExtension = 'json';
                    break;
                default:
                    reportContent = JSON.stringify(report, null, 2);
                    mimeType = 'text/plain';
                    fileExtension = 'txt';
            }

            // Create and download the file
            const blob = new Blob([reportContent], {
                type: mimeType
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showRogSuccess(`Report exported successfully as ${format.toUpperCase()}!`, 'Export Complete');
            closeExportOptionsModal();
        }

        // Delete report
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }
        function deleteReport(reportId) {
            showRogConfirm(
                'Are you sure you want to delete this report?',
                'Delete Report',
                () => {
                    console.log(`Deleting report ${reportId}...`);
                    // In a real application, this would delete the report
                    showRogSuccess('Report deleted successfully!', 'Report Deleted');
                    loadRecentReports();
                }
            );
        }

        async function loadSettingsData() {
            try {
                console.log('Loading settings data...');
                await loadProfileData();
                setupSettingsForms();
            } catch (error) {
                console.error('Error loading settings data:', error);
            }
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Populate profile form
                    const profileName = document.getElementById('profileName');
                    const profileEmail = document.getElementById('profileEmail');
                    const profilePhone = document.getElementById('profilePhone');

                    if (profileName) profileName.value = adminData.name || '';
                    if (profileEmail) profileEmail.value = adminData.email || '';
                    if (profilePhone) profilePhone.value = adminData.phone || '';
                }
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        // Setup settings forms
        function setupSettingsForms() {
            // Profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateProfile();
                });
            }

            // Password form
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await changePassword();
                });
            }

            // Password strength indicator
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        }

        // Update password strength indicator
        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            if (!strengthIndicator) return;

            const strength = calculatePasswordStrength(password);

            // Remove existing classes
            strengthIndicator.classList.remove('weak', 'medium', 'strong');

            if (password.length === 0) {
                strengthIndicator.style.background = '#333';
                return;
            }

            if (strength < 3) {
                strengthIndicator.classList.add('weak');
            } else if (strength < 5) {
                strengthIndicator.classList.add('medium');
            } else {
                strengthIndicator.classList.add('strong');
            }
        }

        // Calculate password strength
        function calculatePasswordStrength(password) {
            let strength = 0;

            // Length check
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;

            // Character variety checks
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            return strength;
        }

        // Update profile
        async function updateProfile() {
            try {
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;

                // Validate inputs
                if (!name || !email) {
                    showSettingsMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Update admin user data
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);
                    adminData.name = name;
                    adminData.email = email;
                    adminData.phone = phone;
                    adminData.updatedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    // Update UI
                    loadAdminUserInfo();
                    showSettingsMessage('Profile updated successfully!', 'success');

                    // Clear form
                    document.getElementById('profileForm').reset();
                    loadProfileData();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showSettingsMessage('Error updating profile. Please try again.', 'error');
            }
        }

        // Change password
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showSettingsMessage('Please fill in all password fields', 'error');
                    return;
                }

                // Validate password requirements
                if (!validatePassword(newPassword)) {
                    showSettingsMessage('Password does not meet requirements', 'error');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showSettingsMessage('New passwords do not match', 'error');
                    return;
                }

                // Verify current password
                const adminUser = localStorage.getItem('adminUser');
                if (adminUser) {
                    const adminData = JSON.parse(adminUser);

                    // Simple password verification (in real app, this would be server-side)
                    const validPasswords = [{
                            email: 'admin@otomono.com',
                            password: 'admin123'
                        },
                        {
                            email: 'staff@otomono.com',
                            password: 'staff123'
                        },
                        {
                            email: 'miicrossoft@gmail.com',
                            password: 'admin123'
                        }
                    ];

                    const validAdmin = validPasswords.find(a => a.email === adminData.email && a.password === currentPassword);

                    if (!validAdmin) {
                        showSettingsMessage('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password (in real app, this would be server-side)
                    adminData.password = newPassword;
                    adminData.passwordChangedAt = new Date().toISOString();

                    localStorage.setItem('adminUser', JSON.stringify(adminData));

                    showSettingsMessage('Password changed successfully!', 'success');

                    // Clear form
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showSettingsMessage('Error changing password. Please try again.', 'error');
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);

            return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers;
        }

        // Show settings message
        function showSettingsMessage(message, type) {
            const messageDiv = document.getElementById('settingsMessage');
            const messageText = document.getElementById('settingsMessageText');

            if (messageDiv && messageText) {
                messageText.textContent = message;

                // Update styling based on type
                const messageContainer = messageDiv.querySelector('div');
                if (type === 'error') {
                    messageContainer.className = 'bg-red-500/20 border border-red-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400 mr-3';
                    messageText.className = 'text-red-400 font-rog-body';
                } else {
                    messageContainer.className = 'bg-green-500/20 border border-green-500/30 rounded-lg p-4';
                    messageContainer.querySelector('i').className = 'fas fa-check-circle text-green-400 mr-3';
                    messageText.className = 'text-green-400 font-rog-body';
                }

                messageDiv.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Render functions
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (ordersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400 font-rog-body">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = ordersData.map(order => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.id || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.customer || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.material || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(order.status)} rounded-full text-xs font-rog-body">${order.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${order.amount || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${order.date || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button class="text-rog-blue hover:text-rog-purple mr-1" onclick="viewOrder('${order.id}')" title="View Order">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-green-400 hover:text-green-300 mr-1" onclick="generateClientLink('${order.id}')" title="Generate Client Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="text-rog-red hover:text-rog-orange mr-1" onclick="editOrder('${order.id}')" title="Edit Order">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-400 hover:text-red-300" onclick="deleteOrder('${order.id}')" title="Delete Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (customersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-400 font-rog-body">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customersData.map(customer => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.phone || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.orders || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(customer.status)} rounded-full text-xs font-rog-body">${customer.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${customer.joined || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editCustomer('${customer.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderMaterialsTable() {
            const tbody = document.getElementById('materials-table-body');
            if (!tbody) return;

            if (materialsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400 font-rog-body">No materials found</td></tr>';
                return;
            }

            tbody.innerHTML = materialsData.map(material => `
                <tr class="border-b border-rog-gray/50">
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.name || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.type || 'N/A'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">$${material.price || '0.00'}</td>
                    <td class="py-3 px-4 font-rog-body text-gray-300">${material.stock || 0}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${getStatusColor(material.status)} rounded-full text-xs font-rog-body">${material.status || 'N/A'}</span>
                    </td>
                    <td class="py-3 px-4">
                        <button class="text-rog-red hover:text-rog-orange mr-2" onclick="editMaterial('${material.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteMaterial('${material.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-500/20 text-yellow-400',
                'processing': 'bg-blue-500/20 text-blue-400',
                'completed': 'bg-green-500/20 text-green-400',
                'cancelled': 'bg-red-500/20 text-red-400',
                'active': 'bg-green-500/20 text-green-400',
                'inactive': 'bg-gray-500/20 text-gray-400'
            };
            return colors[status] || 'bg-gray-500/20 text-gray-400';
        }

        // Stats update functions
        async function updateCustomerStats() {
            const totalCustomers = document.getElementById('total-customers');
            const activeCustomers = document.getElementById('active-customers');
            const newCustomers = document.getElementById('new-customers');

            if (totalCustomers) totalCustomers.textContent = customersData.length;
            if (activeCustomers) activeCustomers.textContent = customersData.filter(c => c.status === 'active').length;
            if (newCustomers) newCustomers.textContent = customersData.filter(c => {
                const joinedDate = new Date(c.joined);
                const now = new Date();
                const monthDiff = (now - joinedDate) / (1000 * 60 * 60 * 24 * 30);
                return monthDiff < 1;
            }).length;
        }

        async function updateMaterialStats() {
            const totalMaterials = document.getElementById('total-materials');
            const materialsInStock = document.getElementById('materials-in-stock');
            const materialsLowStock = document.getElementById('materials-low-stock');
            const materialsOutOfStock = document.getElementById('materials-out-of-stock');

            if (totalMaterials) totalMaterials.textContent = materialsData.length;
            if (materialsInStock) materialsInStock.textContent = materialsData.filter(m => m.stock > 10).length;
            if (materialsLowStock) materialsLowStock.textContent = materialsData.filter(m => m.stock <= 10 && m.stock > 0).length;
            if (materialsOutOfStock) materialsOutOfStock.textContent = materialsData.filter(m => m.stock === 0).length;
        }

        async function updateAnalyticsStats() {
            try {
                if (window.firebaseDb && collection) {
                    const ordersRef = collection(window.firebaseDb, 'orders');
                    const ordersSnapshot = await getDocs(ordersRef);
                    const orders = ordersSnapshot.docs.map(doc => doc.data());

                    const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.amount) || 0), 0);
                    const avgOrderValue = orders.length > 0 ? totalRevenue / orders.length : 0;

                    // Calculate dynamic conversion rate based on completed orders vs total orders
                    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'completed').length;
                    const conversionRate = orders.length > 0 ? Math.round((completedOrders / orders.length) * 100) : 0;

                    // Calculate dynamic customer satisfaction based on order status distribution
                    const satisfiedOrders = orders.filter(order =>
                        order.status === 'delivered' ||
                        order.status === 'completed' ||
                        order.status === 'processing'
                    ).length;
                    const customerSatisfaction = orders.length > 0 ? Math.round((satisfiedOrders / orders.length) * 100) : 0;

                    const totalRevenueEl = document.getElementById('total-revenue');
                    const avgOrderValueEl = document.getElementById('avg-order-value');
                    const conversionRateEl = document.getElementById('conversion-rate');
                    const customerSatisfactionEl = document.getElementById('customer-satisfaction');

                    if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
                    if (avgOrderValueEl) avgOrderValueEl.textContent = `$${avgOrderValue.toFixed(2)}`;
                    if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
                    if (customerSatisfactionEl) customerSatisfactionEl.textContent = `${customerSatisfaction}%`;
                }
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        // Modal functionality
        function setupModals() {
            // Order modal
            const orderModal = document.getElementById('orderModal');
            const addOrderBtn = document.getElementById('add-order-btn');
            const closeOrderModal = document.getElementById('closeOrderModal');
            const cancelOrder = document.getElementById('cancelOrder');
            const orderForm = document.getElementById('orderForm');

            if (addOrderBtn) {
                addOrderBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('orderModalTitle').textContent = 'Add New Order';
                    orderForm.reset();
                    orderModal.classList.remove('hidden');
                });
            }

            if (closeOrderModal) {
                closeOrderModal.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (cancelOrder) {
                cancelOrder.addEventListener('click', () => {
                    orderModal.classList.add('hidden');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveOrder();
                });
            }

            // Customer modal
            const customerModal = document.getElementById('customerModal');
            const addCustomerBtn = document.getElementById('add-customer-btn');
            const closeCustomerModal = document.getElementById('closeCustomerModal');
            const cancelCustomer = document.getElementById('cancelCustomer');
            const customerForm = document.getElementById('customerForm');

            if (addCustomerBtn) {
                addCustomerBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('customerModalTitle').textContent = 'Add New Customer';
                    customerForm.reset();
                    customerModal.classList.remove('hidden');
                });
            }

            if (closeCustomerModal) {
                closeCustomerModal.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (cancelCustomer) {
                cancelCustomer.addEventListener('click', () => {
                    customerModal.classList.add('hidden');
                });
            }

            if (customerForm) {
                customerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveCustomer();
                });
            }

            // Product modal
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeProductModal = document.getElementById('closeProductModal');
            const cancelProduct = document.getElementById('cancelProduct');
            const productForm = document.getElementById('productForm');

            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('productModalTitle').textContent = 'Add New Product';
                    productForm.reset();
                    productModal.classList.remove('hidden');
                });
            }

            if (closeProductModal) {
                closeProductModal.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (cancelProduct) {
                cancelProduct.addEventListener('click', () => {
                    productModal.classList.add('hidden');
                });
            }

            if (productForm) {
                productForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveProduct();
                });
            }

            // Material modal
            const materialModal = document.getElementById('materialModal');
            const addMaterialBtn = document.getElementById('add-material-btn');
            const closeMaterialModal = document.getElementById('closeMaterialModal');
            const cancelMaterial = document.getElementById('cancelMaterial');
            const materialForm = document.getElementById('materialForm');

            if (addMaterialBtn) {
                addMaterialBtn.addEventListener('click', () => {
                    currentEditId = null;
                    document.getElementById('materialModalTitle').textContent = 'Add New Material';
                    materialForm.reset();
                    materialModal.classList.remove('hidden');
                });
            }

            if (closeMaterialModal) {
                closeMaterialModal.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (cancelMaterial) {
                cancelMaterial.addEventListener('click', () => {
                    materialModal.classList.add('hidden');
                });
            }

            if (materialForm) {
                materialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveMaterial();
                });
            }
        }

        // Save functions
        async function saveOrder() {
            try {
                const orderData = {
                    customer: document.getElementById('orderCustomer').value,
                    email: document.getElementById('orderEmail').value,
                    phone: document.getElementById('orderPhone').value,
                    material: document.getElementById('orderMaterial').value,
                    quantity: parseInt(document.getElementById('orderQuantity').value),
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    status: document.getElementById('orderStatus').value,
                    notes: document.getElementById('orderNotes').value,
                    date: new Date().toISOString().split('T')[0],
                    updatedAt: new Date()
                };

                if (currentEditId) {
                    // Update existing order
                    if (window.firebaseDb && updateDoc && doc) {
                        const orderRef = doc(window.firebaseDb, 'orders', currentEditId);
                        await updateDoc(orderRef, orderData);
                        console.log('Order updated successfully');
                        showRogSuccess('Order updated successfully!', 'Order Updated');
                    }
                } else {
                    // Create new order
                    orderData.createdAt = new Date();
                    if (window.firebaseDb && addDoc && collection) {
                        const ordersRef = collection(window.firebaseDb, 'orders');
                        await addDoc(ordersRef, orderData);
                        console.log('Order created successfully');
                        showRogSuccess('Order created successfully!', 'Order Created');
                    }
                }

                // Reset form and close modal
                currentEditId = null;
                document.getElementById('orderModalTitle').textContent = 'Add New Order';
                document.getElementById('orderModal').classList.add('hidden');

                // Refresh data
                await loadOrdersData();
                await loadDashboardData();
            } catch (error) {
                console.error('Error saving order:', error);
                showRogError('Error saving order. Please try again.', 'Save Failed');
            }
        }

        async function saveCustomer() {
            try {
                const customerData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    status: document.getElementById('customerStatus').value,
                    orders: 0,
                    joined: new Date().toISOString().split('T')[0],
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const customersRef = collection(window.firebaseDb, 'customers');
                    await addDoc(customersRef, customerData);
                    console.log('Customer saved successfully');
                }

                document.getElementById('customerModal').classList.add('hidden');
                await loadCustomersData();
            } catch (error) {
                console.error('Error saving customer:', error);
            }
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value,
                    status: 'active',
                    createdAt: new Date()
                };

                if (window.firebaseDb && addDoc) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    await addDoc(productsRef, productData);
                    console.log('Product saved successfully');
                }

                document.getElementById('productModal').classList.add('hidden');
                await loadProductsData();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // Action functions
        function viewOrder(orderId) {
            console.log('View order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Create order details modal
            showOrderDetailsModal(order);
        }

        function generateClientLink(orderId) {
            console.log('Generate client link for order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Generate a unique client link with complete order details
            const orderDetails = {
                orderId: orderId,
                customerName: order.customer || '',
                customerEmail: order.email || '',
                mobileNumber: order.phone || '',
                materialPreference: order.material || '',
                quantity: order.quantity || 1,
                amount: order.amount || '',
                status: order.status || 'processing',
                createdAt: order.date || new Date().toISOString(),
                // Include all order fields that might be needed
                customer: order.customer || '',
                email: order.email || '',
                phone: order.phone || '',
                product: order.product || '',
                material: order.material || '',
                notes: order.notes || ''
            };

            // Encode order details as URL parameters
            const params = new URLSearchParams(orderDetails);
            const clientLink = `${window.location.origin}/client-order-form.html?${params.toString()}&token=${generateToken()}`;

            // Show the link in a modal
            showClientLinkModal(order, clientLink);
        }

        // Show order details modal with client-submitted details (same format as client form)
        function showOrderDetailsModal(order) {
            console.log('Order data for details:', order);

            // Generate order summary with size breakdowns (same as client form)
            const summary = generateOrderSummary(order);

            // Generate jersey details HTML (same as client form)
            const jerseyDetailsHTML = generateJerseyDetailsHTML(order);

            const modalHtml = `
                <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Order Details - ${order.id || 'N/A'}</h3>
                                <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Order Summary (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-chart-pie text-rog-red mr-2"></i>Order Summary
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Size Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-ruler text-rog-blue mr-2"></i>Size Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.sizeBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.size}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        <!-- Category Breakdown -->
                                        <div class="bg-rog-light/30 rounded-lg p-4">
                                            <h5 class="text-lg font-rog-heading font-semibold text-white mb-3 flex items-center">
                                                <i class="fas fa-users text-rog-green mr-2"></i>Category Breakdown
                                            </h5>
                                            <div class="space-y-2">
                                                ${summary.categoryBreakdown.map(item => `
                                                    <div class="flex justify-between items-center py-1 border-b border-rog-gray/50">
                                                        <span class="text-gray-300">${item.category}</span>
                                                        <span class="text-white font-semibold">${item.count}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Summary -->
                                    <div class="mt-4 bg-rog-gray/50 rounded-lg p-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-lg font-semibold text-white">Total Jerseys:</span>
                                            <span class="text-2xl font-bold text-rog-red">${summary.totalJerseys}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initial Order Details (same as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-shopping-cart text-rog-blue mr-2"></i>Initial Order Details
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div><strong class="text-gray-300">Order ID:</strong> <span class="text-white">${order.id || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Customer:</strong> <span class="text-white">${order.customer || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Email:</strong> <span class="text-white">${order.email || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Mobile:</strong> <span class="text-white">${order.phone || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Quantity:</strong> <span class="text-white">${order.quantity || 1}</span></div>
                                        <div><strong class="text-gray-300">Material:</strong> <span class="text-white">${order.material || 'N/A'}</span></div>
                                        <div><strong class="text-gray-300">Status:</strong> ${getStatusBadge(order.status || 'processing')}</div>
                                        <div><strong class="text-gray-300">Created:</strong> <span class="text-white">${formatDate(order.date || new Date().toISOString())}</span></div>
                                    </div>
                                </div>

                                <!-- Jersey Details (same format as client form) -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-4">
                                        <i class="fas fa-tshirt text-rog-green mr-2"></i>Jersey Details Submitted by Client
                                    </h4>
                                    ${jerseyDetailsHTML}
                                </div>

                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeOrderDetailsModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Helper functions for order details display (same as client form)
        function generateOrderSummary(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            // Count sizes
            const sizeCounts = {};
            const categoryCounts = {};

            jerseys.forEach(jersey => {
                const size = jersey.size || 'N/A';
                const category = jersey.sizeCategory || 'N/A';

                sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            // Convert to arrays for display
            const sizeBreakdown = Object.entries(sizeCounts)
                .map(([size, count]) => ({
                    size,
                    count
                }))
                .sort((a, b) => {
                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
                    return sizeOrder.indexOf(a.size) - sizeOrder.indexOf(b.size);
                });

            const categoryBreakdown = Object.entries(categoryCounts)
                .map(([category, count]) => ({
                    category,
                    count
                }))
                .sort((a, b) => a.category.localeCompare(b.category));

            return {
                totalJerseys: jerseys.length,
                sizeBreakdown,
                categoryBreakdown
            };
        }

        function generateJerseyDetailsHTML(order) {
            let jerseys = [];

            // Handle both new format (array) and legacy format (single object)
            if (order.jerseys && Array.isArray(order.jerseys)) {
                jerseys = order.jerseys;
            } else if (order.jerseyType || order.jerseyName || order.jerseyNumber) {
                // Legacy single jersey format
                jerseys = [{
                    jerseyNumber: 1,
                    jerseyType: order.jerseyType || 'N/A',
                    jerseyName: order.jerseyName || 'N/A',
                    jerseyNumberValue: order.jerseyNumber || 'N/A',
                    sizeCategory: order.sizeCategory || 'N/A',
                    size: order.size || 'N/A',
                    sleeve: order.sleeve || 'N/A',
                    shorts: order.shorts || 'N/A',
                    completedAt: order.completedAt || new Date().toISOString()
                }];
            }

            if (jerseys.length === 1) {
                // Single jersey - show in simple format
                const jersey = jerseys[0];
                return `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-gray-300">Jersey Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                        <div><strong class="text-gray-300">Jersey Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                        <div><strong class="text-gray-300">Jersey Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                        <div><strong class="text-gray-300">Size Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                        <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                        <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                        <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                        <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                    </div>
                `;
            } else {
                // Multiple jerseys - show in card format
                return `
                    <div class="space-y-4">
                        ${jerseys.map((jersey, index) => `
                            <div class="bg-rog-light/30 rounded-lg p-4 border border-rog-gray/50">
                                <h5 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i class="fas fa-tshirt mr-2 text-rog-red"></i>
                                    Jersey ${jersey.jerseyNumber || (index + 1)}
                                </h5>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><strong class="text-gray-300">Type:</strong> <span class="text-white">${jersey.jerseyType}</span></div>
                                    <div><strong class="text-gray-300">Name:</strong> <span class="text-white">${jersey.jerseyName}</span></div>
                                    <div><strong class="text-gray-300">Number:</strong> <span class="text-white">${jersey.jerseyNumberValue}</span></div>
                                    <div><strong class="text-gray-300">Category:</strong> <span class="text-white">${jersey.sizeCategory}</span></div>
                                    <div><strong class="text-gray-300">Size:</strong> <span class="text-white">${jersey.size}</span></div>
                                    <div><strong class="text-gray-300">Sleeve:</strong> <span class="text-white">${jersey.sleeve}</span></div>
                                    <div><strong class="text-gray-300">Shorts:</strong> <span class="text-white">${jersey.shorts}</span></div>
                                    <div><strong class="text-gray-300">Submitted:</strong> <span class="text-white">${formatDate(jersey.completedAt)}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                return date.toLocaleDateString();
            } catch (error) {
                console.warn('Date formatting error:', error);
                return 'N/A';
            }
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();

            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                    <i class="fas fa-clock mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('processing') || statusLower.includes('in progress')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                    <i class="fas fa-cog mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('completed') || statusLower.includes('done') || statusLower.includes('finished')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('cancelled') || statusLower.includes('canceled')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                    <i class="fas fa-times-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('on hold') || statusLower.includes('paused')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200">
                    <i class="fas fa-pause-circle mr-1"></i>
                    ${status}
                </span>`;
            } else if (statusLower.includes('shipped') || statusLower.includes('delivered')) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                    <i class="fas fa-truck mr-1"></i>
                    ${status}
                </span>`;
            } else {
                // Default status styling
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${status}
                </span>`;
            }
        }

        // Show client link modal
        function showClientLinkModal(order, clientLink) {
            const modalHtml = `
                <div id="clientLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Client Link Generated</h3>
                                <button onclick="closeClientLinkModal()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Order ID</label>
                                    <p class="text-white font-rog-body">${order.id || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-rog-heading font-medium text-rog-red mb-2">Client Link</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="clientLinkInput" value="${clientLink}" readonly class="flex-1 px-4 py-3 bg-rog-light/20 border border-rog-red/30 rounded-lg text-white font-rog-body">
                                        <button onclick="copyClientLink()" class="px-4 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="bg-green-500/20 border border-green-500/30 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-green-400 mr-3"></i>
                                        <div>
                                            <p class="text-green-400 font-rog-body text-sm">
                                                Share this link with your client to collect jersey details. The link will allow them to provide specific requirements for their order.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="closeClientLinkModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg font-rog-heading font-semibold hover:bg-gray-700 transition-colors duration-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close order details modal
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close client link modal
        function closeClientLinkModal() {
            const modal = document.getElementById('clientLinkModal');
            if (modal) {
                modal.remove();
            }
        }

        // Copy client link to clipboard
        function copyClientLink() {
            const linkInput = document.getElementById('clientLinkInput');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');

                // Show success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.add('bg-green-600');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            }
        }

        // Generate token for client link
        function generateToken() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function editOrder(orderId) {
            console.log('Edit order:', orderId);
            // Find the order in ordersData
            const order = ordersData.find(o => o.id === orderId);
            if (!order) {
                showRogError('Order not found', 'Order Not Found');
                return;
            }

            // Set current edit ID
            currentEditId = orderId;

            // Update modal title
            document.getElementById('orderModalTitle').textContent = 'Edit Order';

            // Populate form fields with existing order data (only fields that exist in the form)
            document.getElementById('orderCustomer').value = order.customer || '';
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderPhone').value = order.phone || '';
            document.getElementById('orderMaterial').value = order.material || '';
            document.getElementById('orderQuantity').value = order.quantity || '';
            document.getElementById('orderAmount').value = order.amount || '';
            document.getElementById('orderStatus').value = order.status || '';
            document.getElementById('orderNotes').value = order.notes || '';

            // Show the modal
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function deleteOrder(orderId) {
            showRogConfirm(
                'Are you sure you want to delete this order?',
                'Delete Order',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const orderRef = doc(window.firebaseDb, 'orders', orderId);
                            await deleteDoc(orderRef);
                            console.log('Order deleted successfully');
                            showRogSuccess('Order deleted successfully!', 'Order Deleted');
                            await loadOrdersData();
                            await loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showRogError('Error deleting order. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        function editCustomer(customerId) {
            console.log('Edit customer:', customerId);
            // Implement edit customer functionality
        }

        async function deleteCustomer(customerId) {
            showRogConfirm(
                'Are you sure you want to delete this customer?',
                'Delete Customer',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const customerRef = doc(window.firebaseDb, 'customers', customerId);
                            await deleteDoc(customerRef);
                            console.log('Customer deleted successfully');
                            showRogSuccess('Customer deleted successfully!', 'Customer Deleted');
                            await loadCustomersData();
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showRogError('Error deleting customer. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function saveMaterial() {
            try {
                const materialData = {
                    name: document.getElementById('materialName').value,
                    type: document.getElementById('materialType').value,
                    price: parseFloat(document.getElementById('materialPrice').value),
                    stock: parseInt(document.getElementById('materialStock').value),
                    status: document.getElementById('materialStatus').value,
                    description: document.getElementById('materialDescription').value
                };

                if (window.firebaseDb && addDoc && collection) {
                    const materialsRef = collection(window.firebaseDb, 'materials');
                    await addDoc(materialsRef, materialData);
                    console.log('Material saved successfully');
                    showRogSuccess('Material saved successfully!', 'Material Saved');
                    document.getElementById('materialModal').classList.add('hidden');
                    await loadMaterialsData();
                }
            } catch (error) {
                console.error('Error saving material:', error);
                showRogError('Error saving material. Please try again.', 'Save Failed');
            }
        }

        function editMaterial(materialId) {
            console.log('Edit material:', materialId);
            const material = materialsData.find(m => m.id === materialId);
            if (material) {
                currentEditId = materialId;
                document.getElementById('materialModalTitle').textContent = 'Edit Material';
                document.getElementById('materialName').value = material.name || '';
                document.getElementById('materialType').value = material.type || '';
                document.getElementById('materialPrice').value = material.price || '';
                document.getElementById('materialStock').value = material.stock || '';
                document.getElementById('materialStatus').value = material.status || '';
                document.getElementById('materialDescription').value = material.description || '';
                document.getElementById('materialModal').classList.remove('hidden');
            }
        }

        async function deleteMaterial(materialId) {
            showRogConfirm(
                'Are you sure you want to delete this material?',
                'Delete Material',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const materialRef = doc(window.firebaseDb, 'materials', materialId);
                            await deleteDoc(materialRef);
                            console.log('Material deleted successfully');
                            showRogSuccess('Material deleted successfully!', 'Material Deleted');
                            await loadMaterialsData();
                        }
                    } catch (error) {
                        console.error('Error deleting material:', error);
                        showRogError('Error deleting material. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        // Notification functionality
        function setupNotifications() {
            const notificationBtn = document.getElementById('notification-btn');
            const notificationCenter = document.getElementById('notification-center');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');
            const clearAllBtn = document.getElementById('clear-all-notifications');

            if (notificationBtn && notificationCenter) {
                notificationBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    notificationCenter.classList.toggle('hidden');
                });

                // Close notification center when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationCenter.contains(e.target)) {
                        notificationCenter.classList.add('hidden');
                    }
                });
            }

            // Clear all notifications
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearAllNotifications();
                });
            }

            // Check if notifications were cleared
            const notificationsCleared = localStorage.getItem('notificationsCleared');
            const clearedTime = localStorage.getItem('notificationsClearedTime');

            if (notificationsCleared === 'true' && clearedTime) {
                // Check if cleared within last 24 hours
                const timeDiff = Date.now() - parseInt(clearedTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);

                if (hoursDiff < 24) {
                    // Keep notifications cleared
                    if (notificationCount) {
                        notificationCount.classList.add('opacity-0', 'pointer-events-none');
                        notificationCount.classList.remove('opacity-100');
                    }
                    if (notificationList) {
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                    }
                    return; // Don't load notifications
                } else {
                    // Clear the stored state after 24 hours
                    localStorage.removeItem('notificationsCleared');
                    localStorage.removeItem('notificationsClearedTime');
                }
            }

            // Load notifications only if not cleared
            loadNotifications();
        }

        async function loadNotifications() {
            try {
                const notifications = [{
                        id: 1,
                        title: 'New Order Received',
                        message: 'Order #ORD-001 has been placed',
                        time: '2 minutes ago',
                        type: 'order'
                    },
                    {
                        id: 2,
                        title: 'Customer Registration',
                        message: 'New customer registered',
                        time: '15 minutes ago',
                        type: 'customer'
                    },
                    {
                        id: 3,
                        title: 'Low Stock Alert',
                        message: 'Waffle material is running low',
                        time: '1 hour ago',
                        type: 'inventory'
                    }
                ];

                renderNotifications(notifications);
                updateNotificationCount(notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
                return;
            }

            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-4 border-b border-rog-gray/50 hover:bg-rog-gray/20 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-2 h-2 bg-rog-red rounded-full mt-2 flex-shrink-0"></div>
                        <div class="flex-1">
                            <h4 class="text-sm font-rog-heading font-semibold text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-400 font-rog-body mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-500 font-rog-body mt-1">${notification.time}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNotificationCount(count) {
            const notificationCount = document.getElementById('notification-count');
            if (notificationCount) {
                if (count > 0) {
                    notificationCount.textContent = count;
                    notificationCount.classList.remove('opacity-0', 'pointer-events-none');
                    notificationCount.classList.add('opacity-100');
                } else {
                    notificationCount.classList.add('opacity-0', 'pointer-events-none');
                    notificationCount.classList.remove('opacity-100');
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            const notificationList = document.getElementById('notification-list');
            const notificationCount = document.getElementById('notification-count');

            if (notificationList) {
                notificationList.innerHTML = '<div class="p-4 text-center text-gray-400 font-rog-body">No notifications</div>';
            }

            if (notificationCount) {
                notificationCount.classList.add('opacity-0', 'pointer-events-none');
                notificationCount.classList.remove('opacity-100');
            }

            // Store cleared state in localStorage
            localStorage.setItem('notificationsCleared', 'true');
            localStorage.setItem('notificationsClearedTime', Date.now().toString());

            console.log('All notifications cleared');
        }

        // User profile dropdown functionality
        function setupUserProfile() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (userProfileBtn && userDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    userDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Load admin user information
        function loadAdminUserInfo() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const adminName = document.getElementById('admin-name');
                    const adminEmail = document.getElementById('admin-email');
                    const adminAvatar = document.getElementById('admin-avatar');

                    if (adminName) adminName.textContent = adminData.name || 'Admin User';
                    if (adminEmail) adminEmail.textContent = adminData.email || 'admin@otomono.mv';

                    if (adminAvatar && adminData.name) {
                        const initial = adminData.name.charAt(0).toUpperCase();
                        adminAvatar.innerHTML = `<span class="text-white text-sm font-rog-heading font-bold">${initial}</span>`;
                    }

                    // Update page title with admin name
                    document.title = `Admin Panel - ${adminData.name || 'Admin'}`;
                } catch (error) {
                    console.error('Error loading admin user info:', error);
                }
            }
        }

        // Session duration tracking
        function updateSessionDuration() {
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                try {
                    const adminData = JSON.parse(adminUser);
                    const loginTime = new Date(adminData.loginTime);
                    const now = new Date();
                    const diffMs = now - loginTime;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                    const sessionDuration = document.getElementById('session-duration');
                    if (sessionDuration) {
                        sessionDuration.textContent = `${diffHours}h ${diffMinutes}m`;
                    }
                } catch (error) {
                    console.error('Error updating session duration:', error);
                }
            }
        }

        // Logout functionality
        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        // Missing functions
        function editProduct(productId) {
            console.log('Edit product:', productId);
            // Implement edit product functionality
        }

        async function deleteProduct(productId) {
            showRogConfirm(
                'Are you sure you want to delete this product?',
                'Delete Product',
                async () => {
                    try {
                        if (window.firebaseDb && deleteDoc && doc) {
                            const productRef = doc(window.firebaseDb, 'products', productId);
                            await deleteDoc(productRef);
                            console.log('Product deleted successfully');
                            showRogSuccess('Product deleted successfully!', 'Product Deleted');
                            await loadProductsData();
                        }
                    } catch (error) {
                        console.error('Error deleting product:', error);
                        showRogError('Error deleting product. Please try again.', 'Delete Failed');
                    }
                }
            );
        }

        async function loadProductsData() {
            try {
                console.log('Loading products data...');
                if (window.firebaseDb && collection) {
                    const productsRef = collection(window.firebaseDb, 'products');
                    const q = query(productsRef, orderBy('createdAt', 'desc'));
                    const productsSnapshot = await getDocs(q);
                    const productsData = productsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Update products table if it exists
                    console.log('Products loaded:', productsData);
                }
            } catch (error) {
                console.error('Error loading products data:', error);
            }
        }

        // Navigation functions
        function navigateToSettings() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            // Navigate to settings section
            showPage('settings');
        }

        // Dashboard quick action navigation functions
        function navigateToOrders() {
            console.log('Opening Add New Order form...');
            // Navigate to orders section first
            showPage('orders');

            // Then trigger the Add New Order form
            setTimeout(() => {
                const addOrderBtn = document.getElementById('add-order-btn');
                if (addOrderBtn) {
                    addOrderBtn.click();
                }
            }, 100);
        }

        function navigateToAnalytics() {
            console.log('Navigating to Analytics section...');
            showPage('analytics');
        }

        function navigateToReports() {
            console.log('Navigating to Reports section...');
            showPage('reports');
        }

        // Alias for showPage function
        function showSection(sectionId) {
            showPage(sectionId);
        }

        // Help dialog functionality
        function showHelpDialog() {
            // Close user dropdown
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown) {
                userDropdown.classList.add('hidden');
            }

            const helpDialogHtml = `
                <div id="helpDialog" class="fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-rog-light rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-rog-display font-bold text-white">Admin Panel Help</h3>
                                <button onclick="closeHelpDialog()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Navigation Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-compass text-rog-red mr-2"></i>Navigation
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Sidebar Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Dashboard - Overview and statistics</li>
                                                <li><span class="text-rog-red"></span> Orders - Manage customer orders</li>
                                                <li><span class="text-rog-red"></span> Customers - Customer management</li>
                                                <li><span class="text-rog-red"></span> Materials - Inventory materials</li>
                                                <li><span class="text-rog-red"></span> Products - Product catalog</li>
                                                <li><span class="text-rog-red"></span> Analytics - Charts and insights</li>
                                                <li><span class="text-rog-red"></span> Reports - Generate reports</li>
                                                <li><span class="text-rog-red"></span> Settings - Profile and security</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Header Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Mobile Menu - Toggle sidebar on mobile</li>
                                                <li><span class="text-rog-red"></span> Notifications - View system alerts</li>
                                                <li><span class="text-rog-red"></span> Refresh - Reload current data</li>
                                                <li><span class="text-rog-red"></span> Profile - User settings and logout</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Order Management Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-shopping-cart text-rog-red mr-2"></i>Order Management
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See order details</li>
                                                <li><span class="text-rog-red"></span> Generate Link - Create client form link</li>
                                                <li><span class="text-rog-red"></span> Edit - Modify order information</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove order</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Order Filters</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Search by ID, customer, or product</li>
                                                <li><span class="text-rog-red"></span> Filter by status (Pending, Processing, etc.)</li>
                                                <li><span class="text-rog-red"></span> Date range filtering</li>
                                                <li><span class="text-rog-red"></span> Real-time search results</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-chart-line text-rog-red mr-2"></i>Analytics & Reports
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Analytics Charts</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Sales Trend - 7-day sales data</li>
                                                <li><span class="text-rog-red"></span> Order Status - Distribution pie chart</li>
                                                <li><span class="text-rog-red"></span> Monthly Revenue - 6-month bar chart</li>
                                                <li><span class="text-rog-red"></span> Customer Growth - Acquisition trends</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Report Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> View - See report details</li>
                                                <li><span class="text-rog-red"></span> Export - PDF, Excel, CSV, JSON</li>
                                                <li><span class="text-rog-red"></span> Download - Direct file download</li>
                                                <li><span class="text-rog-red"></span> Delete - Remove report</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-cog text-rog-red mr-2"></i>Settings & Security
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Profile Settings</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Update name, email, phone</li>
                                                <li><span class="text-rog-red"></span> Real-time validation</li>
                                                <li><span class="text-rog-red"></span> Success notifications</li>
                                                <li><span class="text-rog-red"></span> Form reset after update</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Password Security</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Current password verification</li>
                                                <li><span class="text-rog-red"></span> Password strength indicator</li>
                                                <li><span class="text-rog-red"></span> 8+ characters, mixed case, numbers</li>
                                                <li><span class="text-rog-red"></span> Secure password change process</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keyboard Shortcuts -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-keyboard text-rog-red mr-2"></i>Keyboard Shortcuts
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Navigation</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + 1</span> - Dashboard</li>
                                                <li><span class="text-rog-red">Ctrl + 2</span> - Orders</li>
                                                <li><span class="text-rog-red">Ctrl + 3</span> - Customers</li>
                                                <li><span class="text-rog-red">Ctrl + 4</span> - Materials</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Actions</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red">Ctrl + R</span> - Refresh data</li>
                                                <li><span class="text-rog-red">Ctrl + N</span> - New item</li>
                                                <li><span class="text-rog-red">Esc</span> - Close modals</li>
                                                <li><span class="text-rog-red">F1</span> - Show this help</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mobile Help -->
                                <div class="bg-rog-light/20 rounded-lg p-4">
                                    <h4 class="text-lg font-rog-heading font-semibold text-white mb-3">
                                        <i class="fas fa-mobile-alt text-rog-red mr-2"></i>Mobile Usage
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Touch Controls</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Tap menu button to toggle sidebar</li>
                                                <li><span class="text-rog-red"></span> Swipe gestures for navigation</li>
                                                <li><span class="text-rog-red"></span> Touch-friendly buttons</li>
                                                <li><span class="text-rog-red"></span> Responsive table scrolling</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-rog-heading font-semibold text-rog-red mb-2">Mobile Features</h5>
                                            <ul class="space-y-1 text-sm text-gray-300">
                                                <li><span class="text-rog-red"></span> Auto-hide sidebar on navigation</li>
                                                <li><span class="text-rog-red"></span> Optimized chart display</li>
                                                <li><span class="text-rog-red"></span> Touch-optimized modals</li>
                                                <li><span class="text-rog-red"></span> Mobile-friendly forms</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end mt-6">
                                <button onclick="closeHelpDialog()" class="px-6 py-3 bg-rog-red text-white rounded-lg font-rog-heading font-semibold hover:bg-rog-orange transition-colors duration-300">
                                    Close Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', helpDialogHtml);
        }

        // Close help dialog
        function closeHelpDialog() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog) {
                helpDialog.remove();
            }
        }


        // Make functions global
        window.logout = logout;
        window.editOrder = editOrder;
        window.deleteOrder = deleteOrder;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.editMaterial = editMaterial;
        window.deleteMaterial = deleteMaterial;
        window.saveMaterial = saveMaterial;
        window.generateReport = generateReport;
        window.downloadReport = downloadReport;
        window.deleteReport = deleteReport;
        window.viewOrder = viewOrder;
        window.generateClientLink = generateClientLink;
        window.closeOrderDetailsModal = closeOrderDetailsModal;
        window.closeClientLinkModal = closeClientLinkModal;
        window.copyClientLink = copyClientLink;
        window.showRogDialog = showRogDialog;
        window.closeRogDialog = closeRogDialog;
        window.showRogAlert = showRogAlert;
        window.showRogConfirm = showRogConfirm;
        window.showRogSuccess = showRogSuccess;
        window.showRogError = showRogError;
        window.viewReport = viewReport;
        window.exportReport = exportReport;
        window.closeReportDetailsModal = closeReportDetailsModal;
        window.closeExportOptionsModal = closeExportOptionsModal;
        window.executeExport = executeExport;
        window.navigateToSettings = navigateToSettings;
        window.navigateToOrders = navigateToOrders;
        window.navigateToAnalytics = navigateToAnalytics;
        window.navigateToReports = navigateToReports;
        window.showHelpDialog = showHelpDialog;
        window.closeHelpDialog = closeHelpDialog;
        window.showPage = showPage;
        window.showSection = showSection;

        // Refresh functionality
        function setupRefresh() {
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const icon = refreshBtn.querySelector('i');
                    icon.classList.add('animate-spin');

                    try {
                        // Force refresh from Firebase for current page
                        switch (currentPage) {
                            case 'dashboard':
                                await loadDashboardData();
                                break;
                            case 'orders':
                                await loadOrdersData();
                                break;
                            case 'customers':
                                await loadCustomersData();
                                break;
                            case 'materials':
                                await loadMaterialsData();
                                break;
                            case 'analytics':
                                await loadAnalyticsData();
                                break;
                            case 'reports':
                                await loadReportsData();
                                break;
                            case 'settings':
                                await loadSettingsData();
                                break;
                            default:
                                await loadPageData(currentPage);
                        }
                        console.log('Data refreshed successfully from Firebase');
                        showRogSuccess('Data refreshed successfully!', 'Refresh Complete');
                    } catch (error) {
                        console.error('Error refreshing data:', error);
                        showRogError('Error refreshing data. Please try again.', 'Refresh Failed');
                    } finally {
                        setTimeout(() => {
                            icon.classList.remove('animate-spin');
                        }, 1000);
                    }
                });
            }
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // You could add user-friendly error notifications here
        }

        // Branded Dialog System
        function showRogDialog(options) {
            const {
                type = 'info',
                    title = 'Notification',
                    message = '',
                    confirmText = 'OK',
                    cancelText = 'Cancel',
                    showCancel = false,
                    onConfirm = null,
                    onCancel = null
            } = options;

            const dialogId = 'rog-dialog-' + Date.now();
            const iconMap = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };

            const dialogHtml = `
                <div id="${dialogId}" class="rog-dialog">
                    <div class="rog-dialog-content">
                        <div class="rog-dialog-header">
                            <div class="rog-dialog-icon ${type}">
                                <i class="${iconMap[type]}"></i>
                            </div>
                            <div class="rog-dialog-title">${title}</div>
                        </div>
                        <div class="rog-dialog-message">${message}</div>
                        <div class="rog-dialog-actions">
                            ${showCancel ? `<button class="rog-dialog-btn secondary" onclick="closeRogDialog('${dialogId}', false)">${cancelText}</button>` : ''}
                            <button class="rog-dialog-btn ${type === 'error' ? 'danger' : 'primary'}" onclick="closeRogDialog('${dialogId}', true)">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', dialogHtml);

            // Store callbacks
            window.rogDialogCallbacks = window.rogDialogCallbacks || {};
            window.rogDialogCallbacks[dialogId] = {
                onConfirm,
                onCancel
            };
        }

        function closeRogDialog(dialogId, confirmed) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    dialog.remove();
                }, 300);
            }

            // Execute callbacks
            if (window.rogDialogCallbacks && window.rogDialogCallbacks[dialogId]) {
                const callbacks = window.rogDialogCallbacks[dialogId];
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window.rogDialogCallbacks[dialogId];
            }
        }

        // Convenience functions
        function showRogAlert(message, title = 'Notification', type = 'info') {
            showRogDialog({
                type,
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogConfirm(message, title = 'Confirmation', onConfirm = null, onCancel = null) {
            showRogDialog({
                type: 'warning',
                title,
                message,
                confirmText: 'Yes',
                cancelText: 'No',
                showCancel: true,
                onConfirm,
                onCancel
            });
        }

        function showRogSuccess(message, title = 'Success') {
            showRogDialog({
                type: 'success',
                title,
                message,
                confirmText: 'OK'
            });
        }

        function showRogError(message, title = 'Error') {
            showRogDialog({
                type: 'error',
                title,
                message,
                confirmText: 'OK'
            });
        }

        // Initialize all functionality
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing admin panel...');

                await initializeFirebase();
                setupMobileSidebar();
                setupNavigation();
                setupModals();
                setupNotifications();
                setupUserProfile();
                setupRefresh();
                loadAdminUserInfo();
                updateSessionDuration();

                // Update session duration every minute
                setInterval(updateSessionDuration, 60000);

                // Load initial dashboard data
                await loadDashboardData();

                console.log('Admin panel initialized successfully');
            } catch (error) {
                handleError(error, 'admin panel initialization');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh data
                loadPageData(currentPage);
            }
        });

        // Handle window focus
        window.addEventListener('focus', function() {
            loadPageData(currentPage);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing Reports & Analytics...');
                
                // Initialize Firebase
                await initializeFirebase();
                
                // Setup mobile sidebar and header actions (from admin-common.js)
                if (typeof setupMobileSidebar === 'function') {
                    setupMobileSidebar();
                }
                if (typeof setupHeaderActions === 'function') {
                    setupHeaderActions();
                }
                
                // Update active nav link (from admin-common.js)
                if (typeof updateActiveNavLink === 'function') {
                    updateActiveNavLink();
                }
                
                // Load page data
                if (typeof loadPageData === 'function') {
                    await loadPageData();
                }
                
                console.log('Reports & Analytics initialized successfully');
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        });
    </script>
</body>

</html>